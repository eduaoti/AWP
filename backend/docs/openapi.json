{
  "openapi": "3.0.3",
  "info": {
    "title": "AWP MVP API",
    "version": "1.0.5",
    "description": "Convención de respuestas: siempre HTTP 200. En operaciones de escritura (crear/actualizar/eliminar) se responde SOLO {codigo, mensaje}. En operaciones de listado/consulta/reportes se responde {codigo, mensaje, data}."
  },
  "tags": [
    { "name": "Auth", "description": "Login y validación OTP" },
    { "name": "Recovery", "description": "Recuperación de contraseña" },
    { "name": "Usuarios", "description": "Gestión de usuarios" },
    { "name": "Productos", "description": "Administración de productos" },
    { "name": "Movimientos", "description": "Entradas y salidas (JSON-only)" },
    { "name": "Proveedores", "description": "Directorio de proveedores" },
    { "name": "Clientes", "description": "Directorio de clientes" },
    { "name": "Estadísticas", "description": "Reportes (JSON-only)" }
  ],
  "paths": {
    "/auth/login": {
      "post": {
        "operationId": "authLogin",
        "tags": ["Auth"],
        "summary": "Login (paso 1)",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["email", "password"],
                "properties": {
                  "email": { "type": "string", "format": "email" },
                  "password": { "type": "string", "minLength": 8 }
                },
                "additionalProperties": false
              }
            }
          }
        },
        "responses": { "200": { "$ref": "#/components/responses/Resp200_Min" } }
      }
    },
    "/auth/login/otp": {
      "post": {
        "operationId": "authLoginOtp",
        "tags": ["Auth"],
        "summary": "Verificar OTP (paso 2)",
        "requestBody": {
          "required": true,
          "content": { "application/json": { "schema": {
            "type": "object",
            "required": ["preAuth", "code"],
            "properties": {
              "preAuth": { "type": "string" },
              "code": { "type": "string", "minLength": 6, "maxLength": 8 },
              "deviceId": { "type": "string" }
            },
            "additionalProperties": false
          } } }
        },
        "responses": { "200": { "$ref": "#/components/responses/Resp200_Min" } }
      }
    },
    "/auth/login/offline": {
      "post": {
        "operationId": "authLoginOffline",
        "tags": ["Auth"],
        "summary": "Canjear PIN offline (paso 2 alterno)",
        "requestBody": {
          "required": true,
          "content": { "application/json": { "schema": {
            "type": "object",
            "required": ["preAuth", "offlineJwt", "pin"],
            "properties": {
              "preAuth": { "type": "string" },
              "offlineJwt": { "type": "string" },
              "pin": { "type": "string", "minLength": 4, "maxLength": 10 },
              "deviceId": { "type": "string" }
            },
            "additionalProperties": false
          } } }
        },
        "responses": { "200": { "$ref": "#/components/responses/Resp200_Min" } }
      }
    },

    "/usuarios/nuevo": {
      "post": {
        "operationId": "usuariosCrear",
        "tags": ["Usuarios"],
        "summary": "Crear usuario",
        "requestBody": {
          "required": true,
          "content": { "application/json": { "schema": {
            "type": "object",
            "required": ["nombre", "email", "password", "rol"],
            "properties": {
              "nombre": { "type": "string" },
              "email": { "type": "string", "format": "email" },
              "password": { "type": "string", "minLength": 8 },
              "rol": { "type": "string", "enum": ["admin", "editor", "lector"] }
            },
            "additionalProperties": false
          } } }
        },
        "responses": { "200": { "$ref": "#/components/responses/Resp200_Min" } }
      }
    },
    "/usuarios/actualizar": {
      "put": {
        "operationId": "usuariosActualizar",
        "tags": ["Usuarios"],
        "summary": "Actualizar usuario",
        "requestBody": {
          "required": true,
          "content": { "application/json": { "schema": {
            "type": "object",
            "required": ["id", "nombre", "email", "rol"],
            "properties": {
              "id": { "type": "integer" },
              "nombre": { "type": "string" },
              "email": { "type": "string", "format": "email" },
              "rol": { "type": "string", "enum": ["admin", "editor", "lector"] }
            },
            "additionalProperties": false
          } } }
        },
        "responses": { "200": { "$ref": "#/components/responses/Resp200_Min" } }
      }
    },
    "/usuarios/eliminar": {
      "post": {
        "operationId": "usuariosEliminar",
        "tags": ["Usuarios"],
        "summary": "Eliminar usuario",
        "requestBody": {
          "required": true,
          "content": { "application/json": { "schema": {
            "type": "object",
            "required": ["id"],
            "properties": { "id": { "type": "integer" } },
            "additionalProperties": false
          } } }
        },
        "responses": { "200": { "$ref": "#/components/responses/Resp200_Min" } }
      }
    },
    "/usuarios": {
      "get": {
        "operationId": "usuariosListar",
        "tags": ["Usuarios"],
        "summary": "Listar usuarios",
        "responses": { "200": { "$ref": "#/components/responses/Resp200_UsuariosList" } }
      }
    },

    "/productos": {
      "post": {
        "operationId": "productosCrear",
        "tags": ["Productos"],
        "summary": "Crear producto",
        "requestBody": {
          "required": true,
          "content": { "application/json": { "schema": {
            "type": "object",
            "required": ["clave", "nombre", "unidad", "categoria"],
            "properties": {
              "clave": { "type": "string" },
              "nombre": { "type": "string" },
              "unidad": { "type": "string" },
              "descripcion": { "type": "string" },
              "categoria": { "type": "string" },
              "precio": { "type": "number" },
              "stock_minimo": { "type": "number" },
              "stock_actual": { "type": "number" }
            },
            "additionalProperties": false
          } } }
        },
        "responses": { "200": { "$ref": "#/components/responses/Resp200_Min" } }
      }
    },

    "/productos/listar": {
      "post": {
        "operationId": "productosListarPostJson",
        "tags": ["Productos"],
        "summary": "Listar (POST JSON): por clave, por nombre o todos",
        "description": "Si clave==\"\" no filtra por clave; si nombre==\"\" no filtra por nombre; si ambos \"\", lista todos. Coincidencia exacta case-insensitive para clave y nombre.",
        "requestBody": {
          "required": false,
          "content": { "application/json": { "schema": {
            "type": "object",
            "properties": {
              "clave": { "type": "string" },
              "nombre": { "type": "string" },
              "page": { "type": "integer", "minimum": 1, "default": 1 },
              "per_page": { "type": "integer", "minimum": 1, "maximum": 100, "default": 20 },
              "sort_by": { "type": "string", "enum": ["nombre", "precio", "stock_actual", "creado_en"] },
              "sort_dir": { "type": "string", "enum": ["asc", "desc"] }
            },
            "additionalProperties": false
          },
          "example": { "clave": "", "nombre": "", "page": 1, "per_page": 20, "sort_by": "nombre", "sort_dir": "asc" } } }
        },
        "responses": { "200": { "$ref": "#/components/responses/Resp200_ProductosList" } }
      }
    },

    "/productos/clave/actualizar": {
      "put": {
        "operationId": "productoActualizarPorClaveJson",
        "tags": ["Productos"],
        "summary": "Actualizar por clave (JSON-only)",
        "requestBody": { "required": true, "content": { "application/json": { "schema": {
          "type": "object",
          "required": ["clave"],
          "properties": {
            "clave": { "type": "string" },
            "nombre": { "type": "string" },
            "unidad": { "type": "string" },
            "descripcion": { "type": "string" },
            "categoria": { "type": "string" },
            "precio": { "type": "number" },
            "stock_minimo": { "type": "number" },
            "stock_actual": { "type": "number" }
          },
          "additionalProperties": false
        } } } },
        "responses": { "200": { "$ref": "#/components/responses/Resp200_Min" } }
      }
    },
    "/productos/clave/stock-minimo": {
      "put": {
        "operationId": "productoStockMinimoPorClaveJson",
        "tags": ["Productos"],
        "summary": "Actualizar stock mínimo por clave (JSON-only)",
        "requestBody": { "required": true, "content": { "application/json": { "schema": {
          "type": "object",
          "required": ["clave", "stock_minimo"],
          "properties": { "clave": { "type": "string" }, "stock_minimo": { "type": "number", "minimum": 0 } },
          "additionalProperties": false
        } } } },
        "responses": { "200": { "$ref": "#/components/responses/Resp200_Min" } }
      }
    },
    "/productos/clave/eliminar": {
      "delete": {
        "operationId": "productoEliminarPorClaveJson",
        "tags": ["Productos"],
        "summary": "Eliminar por clave (JSON-only)",
        "requestBody": { "required": true, "content": { "application/json": { "schema": {
          "type": "object",
          "required": ["clave"],
          "properties": { "clave": { "type": "string" } },
          "additionalProperties": false
        } } } },
        "responses": { "200": { "$ref": "#/components/responses/Resp200_Min" } }
      }
    },

    "/productos/actualizar": {
      "put": {
        "operationId": "productoActualizarPorNombreJson",
        "tags": ["Productos"],
        "summary": "Actualizar por nombre (JSON-only)",
        "requestBody": { "required": true, "content": { "application/json": { "schema": {
          "type": "object",
          "required": ["nombre"],
          "properties": {
            "nombre": { "type": "string" },
            "clave": { "type": "string" },
            "unidad": { "type": "string" },
            "descripcion": { "type": "string" },
            "categoria": { "type": "string" },
            "precio": { "type": "number" },
            "stock_minimo": { "type": "number" },
            "stock_actual": { "type": "number" }
          },
          "additionalProperties": false
        } } } },
        "responses": { "200": { "$ref": "#/components/responses/Resp200_Min" } }
      }
    },
    "/productos/stock-minimo": {
      "put": {
        "operationId": "productoStockMinimoPorNombreJson",
        "tags": ["Productos"],
        "summary": "Actualizar stock mínimo por nombre (JSON-only)",
        "requestBody": { "required": true, "content": { "application/json": { "schema": {
          "type": "object",
          "required": ["nombre", "stock_minimo"],
          "properties": { "nombre": { "type": "string" }, "stock_minimo": { "type": "number", "minimum": 0 } },
          "additionalProperties": false
        } } } },
        "responses": { "200": { "$ref": "#/components/responses/Resp200_Min" } }
      }
    },
    "/productos/eliminar": {
      "delete": {
        "operationId": "productoEliminarPorNombreJson",
        "tags": ["Productos"],
        "summary": "Eliminar por nombre (JSON-only)",
        "requestBody": { "required": true, "content": { "application/json": { "schema": {
          "type": "object",
          "required": ["nombre"],
          "properties": { "nombre": { "type": "string" } },
          "additionalProperties": false
        } } } },
        "responses": { "200": { "$ref": "#/components/responses/Resp200_Min" } }
      }
    },

    "/movimientos/entrada": {
      "post": {
        "operationId": "movimientosEntrada",
        "tags": ["Movimientos"],
        "summary": "Registrar entrada (JSON-only)",
        "requestBody": {
          "required": true,
          "content": { "application/json": { "schema": {
            "type": "object",
            "required": ["producto_id", "cantidad"],
            "properties": {
              "producto_id": { "type": "integer", "minimum": 1 },
              "cantidad": { "type": "number", "exclusiveMinimum": 0 },
              "documento": { "type": "string" },
              "responsable": { "type": "string" },
              "fecha": { "type": "string", "format": "date-time" },
              "proveedor_id": { "type": "integer", "minimum": 1 }
            },
            "additionalProperties": false
          } } }
        },
        "responses": { "200": { "$ref": "#/components/responses/Resp200_Min" } }
      }
    },
    "/movimientos/salida": {
      "post": {
        "operationId": "movimientosSalida",
        "tags": ["Movimientos"],
        "summary": "Registrar salida (JSON-only)",
        "requestBody": {
          "required": true,
          "content": { "application/json": { "schema": {
            "type": "object",
            "required": ["producto_id", "cantidad", "cliente_id"],
            "properties": {
              "producto_id": { "type": "integer", "minimum": 1 },
              "cantidad": { "type": "number", "exclusiveMinimum": 0 },
              "documento": { "type": "string" },
              "responsable": { "type": "string" },
              "fecha": { "type": "string", "format": "date-time" },
              "cliente_id": { "type": "integer", "minimum": 1 }
            },
            "additionalProperties": false
          } } }
        },
        "responses": { "200": { "$ref": "#/components/responses/Resp200_Min" } }
      }
    },

    "/proveedores": {
      "get": {
        "operationId": "proveedoresListar",
        "tags": ["Proveedores"],
        "summary": "Listar proveedores",
        "responses": { "200": { "$ref": "#/components/responses/Resp200_ProveedoresList" } }
      },
      "post": {
        "operationId": "proveedoresCrear",
        "tags": ["Proveedores"],
        "summary": "Crear proveedor",
        "requestBody": {
          "required": true,
          "content": { "application/json": { "schema": {
            "type": "object",
            "required": ["nombre"],
            "properties": {
              "nombre": { "type": "string" },
              "telefono": { "type": "string" },
              "contacto": { "type": "string" }
            },
            "additionalProperties": false
          } } }
        },
        "responses": { "200": { "$ref": "#/components/responses/Resp200_Min" } }
      }
    },

    "/clientes": {
      "get": {
        "operationId": "clientesListar",
        "tags": ["Clientes"],
        "summary": "Listar clientes",
        "responses": { "200": { "$ref": "#/components/responses/Resp200_ClientesList" } }
      },
      "post": {
        "operationId": "clientesCrear",
        "tags": ["Clientes"],
        "summary": "Crear cliente",
        "requestBody": {
          "required": true,
          "content": { "application/json": { "schema": {
            "type": "object",
            "required": ["nombre"],
            "properties": {
              "nombre": { "type": "string" },
              "telefono": { "type": "string" },
              "contacto": { "type": "string" }
            },
            "additionalProperties": false
          } } }
        },
        "responses": { "200": { "$ref": "#/components/responses/Resp200_Min" } }
      }
    },

    "/estadisticas/ventas-producto": {
      "post": {
        "operationId": "estadisticasVentasProducto",
        "tags": ["Estadísticas"],
        "summary": "Ventas por producto (JSON-only)",
        "requestBody": {
          "required": false,
          "content": { "application/json": { "schema": {
            "type": "object",
            "properties": {
              "desde": { "type": "string", "format": "date-time" },
              "hasta": { "type": "string", "format": "date-time" }
            },
            "additionalProperties": false
          },
          "example": { "desde": "2025-01-01T00:00:00Z", "hasta": "2025-02-01T00:00:00Z" } } }
        },
        "responses": { "200": { "$ref": "#/components/responses/Resp200_Estad_VentasProducto" } }
      }
    },
    "/estadisticas/productos-menor-venta": {
      "post": {
        "operationId": "estadisticasProductosMenorVenta",
        "tags": ["Estadísticas"],
        "summary": "Productos de menor venta (JSON-only)",
        "requestBody": {
          "required": false,
          "content": { "application/json": { "schema": {
            "type": "object",
            "properties": {
              "desde": { "type": "string", "format": "date-time" },
              "hasta": { "type": "string", "format": "date-time" },
              "limite": { "type": "integer", "minimum": 1, "maximum": 1000, "default": 10 }
            },
            "additionalProperties": false
          } } }
        },
        "responses": { "200": { "$ref": "#/components/responses/Resp200_Estad_MenorVenta" } }
      }
    },
    "/estadisticas/productos-extremos": {
      "post": {
        "operationId": "estadisticasProductosExtremos",
        "tags": ["Estadísticas"],
        "summary": "Más barato y más caro dentro del top N (JSON-only)",
        "requestBody": {
          "required": false,
          "content": { "application/json": { "schema": {
            "type": "object",
            "properties": {
              "desde": { "type": "string", "format": "date-time" },
              "hasta": { "type": "string", "format": "date-time" },
              "top": { "type": "integer", "minimum": 1, "maximum": 1000, "default": 10 }
            },
            "additionalProperties": false
          } } }
        },
        "responses": { "200": { "$ref": "#/components/responses/Resp200_Estad_Extremos" } }
      }
    }
  },
  "components": {
    "schemas": {
      "UsuarioPublico": {
        "type": "object",
        "properties": {
          "id": { "type": "integer" },
          "nombre": { "type": "string" },
          "email": { "type": "string" },
          "rol": { "type": "string" },
          "creado_en": { "type": "string", "format": "date-time" }
        }
      },
      "Producto": {
        "type": "object",
        "properties": {
          "id": { "type": "integer" },
          "clave": { "type": "string" },
          "nombre": { "type": "string" },
          "descripcion": { "type": "string", "nullable": true },
          "categoria": { "type": "string", "nullable": true },
          "unidad": { "type": "string" },
          "precio": { "type": "number" },
          "stock_minimo": { "type": "number" },
          "stock_actual": { "type": "number" },
          "creado_en": { "type": "string", "format": "date-time" },
          "actualizado_en": { "type": "string", "format": "date-time" }
        }
      },
      "Proveedor": {
        "type": "object",
        "properties": {
          "id": { "type": "integer" },
          "nombre": { "type": "string" },
          "telefono": { "type": "string" },
          "contacto": { "type": "string" },
          "creado_en": { "type": "string", "format": "date-time" }
        }
      },
      "Cliente": {
        "type": "object",
        "properties": {
          "id": { "type": "integer" },
          "nombre": { "type": "string" },
          "telefono": { "type": "string" },
          "contacto": { "type": "string" },
          "creado_en": { "type": "string", "format": "date-time" }
        }
      },
      "PaginacionMeta": {
        "type": "object",
        "properties": {
          "page": { "type": "integer" },
          "per_page": { "type": "integer" },
          "total_items": { "type": "integer" },
          "total_pages": { "type": "integer" },
          "has_prev": { "type": "boolean" },
          "has_next": { "type": "boolean" },
          "sort_by": { "type": "string", "enum": ["nombre", "precio", "stock_actual", "creado_en"] },
          "sort_dir": { "type": "string", "enum": ["asc", "desc"] }
        },
        "required": ["page", "per_page", "total_items", "total_pages", "has_prev", "has_next"]
      },
      "ProductoVentaRow": {
        "type": "object",
        "properties": {
          "producto_id": { "type": "integer" },
          "clave": { "type": "string" },
          "nombre": { "type": "string" },
          "total_vendido": { "type": "number" }
        },
        "required": ["producto_id", "clave", "nombre", "total_vendido"]
      },
      "ProductoVentaResumenRow": {
        "type": "object",
        "properties": {
          "producto_id": { "type": "integer" },
          "clave": { "type": "string" },
          "nombre": { "type": "string" },
          "total_vendido": { "type": "number" },
          "precio_referencia": { "type": "number", "nullable": true }
        },
        "required": ["producto_id", "clave", "nombre", "total_vendido"]
      }
    },
    "responses": {
      "Resp200_Min": {
        "description": "Respuesta mínima (escritura). Siempre HTTP 200.",
        "content": { "application/json": { "schema": {
          "type": "object",
          "required": ["codigo", "mensaje"],
          "properties": {
            "codigo": { "type": "integer" },
            "mensaje": { "type": "string" }
          },
          "additionalProperties": false
        }, "example": { "codigo": 0, "mensaje": "OK" } } }
      },

      "Resp200_UsuariosList": {
        "description": "Listar usuarios (trae data)",
        "content": { "application/json": { "schema": {
          "type": "object",
          "required": ["codigo", "mensaje", "data"],
          "properties": {
            "codigo": { "type": "integer" },
            "mensaje": { "type": "string" },
            "data": { "type": "object", "properties": { "items": { "type": "array", "items": { "$ref": "#/components/schemas/UsuarioPublico" } } }, "required": ["items"] }
          },
          "additionalProperties": false
        } } }
      },

      "Resp200_ProductosList": {
        "description": "Listar productos (trae data)",
        "content": { "application/json": { "schema": {
          "type": "object",
          "required": ["codigo", "mensaje", "data"],
          "properties": {
            "codigo": { "type": "integer" },
            "mensaje": { "type": "string" },
            "data": {
              "type": "object",
              "properties": {
                "items": { "type": "array", "items": { "$ref": "#/components/schemas/Producto" } },
                "meta": { "$ref": "#/components/schemas/PaginacionMeta" }
              },
              "required": ["items", "meta"]
            }
          },
          "additionalProperties": false
        } } }
      },

      "Resp200_ProveedoresList": {
        "description": "Listar proveedores (trae data)",
        "content": { "application/json": { "schema": {
          "type": "object",
          "required": ["codigo", "mensaje", "data"],
          "properties": {
            "codigo": { "type": "integer" },
            "mensaje": { "type": "string" },
            "data": { "type": "object", "properties": { "items": { "type": "array", "items": { "$ref": "#/components/schemas/Proveedor" } } }, "required": ["items"] }
          },
          "additionalProperties": false
        } } }
      },

      "Resp200_ClientesList": {
        "description": "Listar clientes (trae data)",
        "content": { "application/json": { "schema": {
          "type": "object",
          "required": ["codigo", "mensaje", "data"],
          "properties": {
            "codigo": { "type": "integer" },
            "mensaje": { "type": "string" },
            "data": { "type": "object", "properties": { "items": { "type": "array", "items": { "$ref": "#/components/schemas/Cliente" } } }, "required": ["items"] }
          },
          "additionalProperties": false
        } } }
      },

      "Resp200_Estad_VentasProducto": {
        "description": "Reporte: ventas por producto",
        "content": { "application/json": { "schema": {
          "type": "object",
          "required": ["codigo", "mensaje", "data"],
          "properties": {
            "codigo": { "type": "integer" },
            "mensaje": { "type": "string" },
            "data": { "type": "object", "properties": {
              "items": { "type": "array", "items": { "$ref": "#/components/schemas/ProductoVentaRow" } }
            }, "required": ["items"] }
          },
          "additionalProperties": false
        } } }
      },

      "Resp200_Estad_MenorVenta": {
        "description": "Reporte: productos de menor venta",
        "content": { "application/json": { "schema": {
          "type": "object",
          "required": ["codigo", "mensaje", "data"],
          "properties": {
            "codigo": { "type": "integer" },
            "mensaje": { "type": "string" },
            "data": { "type": "object", "properties": {
              "items": { "type": "array", "items": { "$ref": "#/components/schemas/ProductoVentaRow" } }
            }, "required": ["items"] }
          },
          "additionalProperties": false
        } } }
      },

      "Resp200_Estad_Extremos": {
        "description": "Reporte: más barato y más caro dentro del top N",
        "content": { "application/json": { "schema": {
          "type": "object",
          "required": ["codigo", "mensaje", "data"],
          "properties": {
            "codigo": { "type": "integer" },
            "mensaje": { "type": "string" },
            "data": {
              "type": "object",
              "properties": {
                "mas_barato_mas_vendido": { "$ref": "#/components/schemas/ProductoVentaResumenRow" },
                "mas_caro_mas_vendido": { "$ref": "#/components/schemas/ProductoVentaResumenRow" }
              }
            }
          },
          "additionalProperties": false
        } } }
      }
    }
  }
}
